function e(e,t){let n=new CustomEvent("storechanged",{detail:{property:e,value:t}});document.dispatchEvent(n)}document.addEventListener("storechanged",e=>{console.log(`Store changed: ${e.detail.property} =`,e.detail.value)});var t={_state:{students:[],tables:[],className:"",tablesLockedGroup:!0,groupCount:6,maxStudentsPerGroup:5,useRoundLayout:!1,hideEmptyTables:!1,groupsEdited:!1},get students(){return this._state.students},get tables(){return this._state.tables},get className(){return this._state.className},get tablesLockedGroup(){return this._state.tablesLockedGroup},get groupCount(){return this._state.groupCount},get maxStudentsPerGroup(){return this._state.maxStudentsPerGroup},get useRoundLayout(){return this._state.useRoundLayout},get hideEmptyTables(){return this._state.hideEmptyTables},get groupsEdited(){return this._state.groupsEdited},set students(value){this._state.students=value,e("students",value)},set tables(value){this._state.tables=value,e("tables",value)},set className(value){this._state.className=value,e("className",value)},set tablesLockedGroup(value){this._state.tablesLockedGroup=value,e("tablesLockedGroup",value)},set groupCount(value){this._state.groupCount=value,e("groupCount",value)},set maxStudentsPerGroup(value){this._state.maxStudentsPerGroup=value,e("maxStudentsPerGroup",value)},set useRoundLayout(value){this._state.useRoundLayout=value,e("useRoundLayout",value)},set hideEmptyTables(value){this._state.hideEmptyTables=value,e("hideEmptyTables",value)},set groupsEdited(value){this._state.groupsEdited=value,e("groupsEdited",value)},getStudentById(e){if(!e)return null;let t=parseInt(e.replace("student-",""));return this.students[t]||null},getTableByNumber(e){return this.tables.find(t=>parseInt(t.dataset.number)===e)},addStudent(e,t=!1){return this.students=[...this.students,{name:e,absent:t,score:0}],this.students.length-1},updateStudentScore(e,t){if(e>=0&&e<this.students.length){let n=[...this.students];n[e]={...n[e],score:t},this.students=n}}},n=class{constructor(e){this.number=e,this.element=this.createTableElement(),this.studentId=null,this.score=0,this.groupNum=1}createTableElement(){let e=document.createElement("div");e.className="table",e.dataset.number=this.number,e.id=`table-${this.number}`;let t=document.createElement("div");t.className="table-number",t.textContent=this.number;let n=document.createElement("div");n.className="score",n.textContent="0";let s=document.createElement("div");s.className="student-name",s.textContent="";let a=document.createElement("div");a.className="controls";let l=document.createElement("button");l.className="btn plus",l.textContent="+",l.onclick=e=>{e.stopPropagation(),this.incrementScore()};let o=document.createElement("button");return o.className="btn minus",o.textContent="-",o.onclick=e=>{e.stopPropagation(),this.decrementScore()},a.appendChild(o),a.appendChild(l),e.appendChild(t),e.appendChild(n),e.appendChild(s),e.appendChild(a),this.setupDragEvents(e),e}setupDragEvents(e){e.addEventListener("dragover",t=>{t.preventDefault(),e.style.backgroundColor="#e0e0e0"}),e.addEventListener("dragleave",()=>{this.updateColor()}),e.addEventListener("drop",t=>{t.preventDefault(),e.style.backgroundColor="#f5f5f5";let n=t.dataTransfer.getData("text/plain");this.assignStudent(n)}),e.addEventListener("mousedown",e=>{if(!t.tablesLockedGroup&&document.getElementById("group-tab").classList.contains("active")){let t=new CustomEvent("tabledraginit",{detail:{table:this,event:e}});document.dispatchEvent(t),e.preventDefault()}})}assignStudent(e){let n=document.getElementById(e);if(n){let s=document.querySelector(`.table[data-student-id="${e}"]`);if(s){let e=t.tables.find(e=>e.element===s);e&&e.removeStudent()}this.studentId=e,this.element.dataset.studentId=e;let a=this.element.querySelector(".student-name"),l=t.getStudentById(e);if(l){a.textContent=l.name;let e=document.createElement("span");e.className="remove-student",e.innerHTML="&times;",e.onclick=e=>{e.stopPropagation(),this.removeStudent()},a.appendChild(e)}n.classList.add("hidden"),this.updateColor()}}removeStudent(){if(!this.studentId)return;let e=document.getElementById(this.studentId);e&&e.classList.remove("hidden");let t=this.element.querySelector(".student-name");t&&(t.textContent=""),this.element.dataset.studentId="",this.studentId=null,this.updateColor()}get score(){let e=this.element.querySelector(".score");return e?parseInt(e.textContent):0}set score(e){let n=this.element.querySelector(".score");if(n){let s=parseInt(e)||0;if(n.textContent=s,this.updateColor(),this.studentId){let e=parseInt(this.studentId.replace("student-",""));t.updateStudentScore(e,s)}console.log(`Table ${this.number} - Score mis \xe0 jour: ${s}`)}}incrementScore(){this.score=this.score+1}decrementScore(){this.score=this.score-1}setPosition(e,t){this.element.style.position="absolute",this.element.style.left=`${e}px`,this.element.style.top=`${t}px`}updateColor(){let e,t=this.score;if(t<0)e="rgba(128, 128, 128, 0.45)";else if(0===t)e="rgba(255, 0, 0, 0.45)";else if(10===t)e="rgba(255, 235, 130, 0.45)";else if(t>=20)e="rgba(100, 255, 0, 0.45)";else{let n;if(t<10){let s=Math.round(235*(n=t/10)),a=Math.round(130*n);e=`rgba(255, ${s}, ${a}, 0.45)`}else{let s=Math.round(255-155*(n=(t-10)/10)),a=Math.round(235+20*n),l=Math.round(130*(1-n));e=`rgba(${s}, ${a}, ${l}, 0.45)`}}this.element.style.backgroundColor=e}};function s(){let e=new Date,n=e.toLocaleDateString("fr-FR").replace(/\//g,"-"),s=e.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}).replace(":","h"),a="TYPE,CLASSROOM_DATA\n";a+=`CLASS_NAME,${t.className}
EXPORT_DATE,${n}
EXPORT_TIME,${s}

TABLE,\xc9L\xc8VE,SCORE,ABSENT,X_POSITION,Y_POSITION
`,t.tables.forEach(e=>{let n=e.element.dataset.number,s=e.element.id.includes("-group")?"group":"bus",l="Non assigné",o=!1,d=t.getStudentById(e.studentId);d&&(l=d.name,o=d.absent);let i=e.score,r="0",u="0";"group"===s&&(r=e.element.style.left||"0",u=e.element.style.top||"0"),a+=`${n},"${l}",${i},${o?"Oui":"Non"},${r},${u}
`}),a+="\nNON_ASSIGNED_STUDENTS\nID,NOM,ABSENT\n";let l=t.tables.filter(e=>e.studentId).map(e=>parseInt(e.studentId.replace("student-","")));t.students.forEach((e,t)=>{l.includes(t)||(a+=`${t},"${e.name}",${e.absent?"Oui":"Non"}
`)});let o=new Blob([new Uint8Array([239,187,191]),a],{type:"text/csv;charset=utf-8;"}),d=document.createElement("a"),i=URL.createObjectURL(o),r=`${t.className||"classe"}_${n}_${s}.csv`;d.setAttribute("href",i),d.setAttribute("download",r),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d)}function a(e,t){let n=document.getElementById("student-labels");if(n.innerHTML="",0===e.length){let e=document.createElement("p");e.id="no-students-message",e.textContent="Chargez une liste d'élèves pour voir les étiquettes ici.",n.appendChild(e);return}e.forEach((e,s)=>{let a=t.includes(s),l=document.createElement("div");l.className="student-label",e.absent&&l.classList.add("absent"),a&&l.classList.add("hidden"),l.textContent=e.name,l.id="student-"+s,l.draggable=!0,l.dataset.absent=e.absent,l.addEventListener("dragstart",function(e){e.dataTransfer.setData("text/plain",l.id)}),n.appendChild(l)})}function l(e){let t=[],n="",s=!1;for(let a=0;a<e.length;a++){let l=e[a];'"'===l?s=!s:","!==l||s?n+=l:(t.push(n),n="")}return t.push(n),t}function o(){document.getElementById("class-name-display").textContent=t.className?`- ${t.className}`:""}function d(e){console.log(`Modification des scores de toutes les tables: ${e>0?"+":""}${e}`),t.tables.forEach(t=>{t.element.dataset.studentId&&(t.score=t.score+e)})}new class{constructor(){this.element=document.getElementById("bus-tab"),this.busClassroom=document.getElementById("classroom-bus"),this.initialize()}initialize(){console.log("Initialisation de l'onglet Bus"),document.addEventListener("tabactivated",e=>{"bus-tab"===e.detail.tabId&&this.onActivate()}),document.getElementById("setAllToTen").addEventListener("click",()=>this.setAllScoresToTen()),this.applyBusLayout()}onActivate(){console.log("Onglet Bus activé"),this.refreshLayout()}refreshLayout(){this.busClassroom.innerHTML="",this.applyBusLayout()}applyBusLayout(){this.busClassroom.innerHTML="";for(let e=0;e<3;e++){let s=document.createElement("div");s.className="column",s.id=`column-${e+1}`;for(let a=0;a<5;a++){let l=document.createElement("div");l.className="pair";let o=10*e+2*a+1,d=10*e+2*a+2,i=t.tables.find(e=>parseInt(e.element.dataset.number)===o),r=t.tables.find(e=>parseInt(e.element.dataset.number)===d);i||(i=new n(o),t.tables.push(i)),r||(r=new n(d),t.tables.push(r)),i.element.style.position="",i.element.style.left="",i.element.style.top="",i.element.style.transition="",i.element.classList.remove("draggable"),r.element.style.position="",r.element.style.left="",r.element.style.top="",r.element.style.transition="",r.element.classList.remove("draggable"),l.appendChild(i.element),l.appendChild(r.element),s.appendChild(l)}this.busClassroom.appendChild(s)}}setAllScoresToTen(){t.tables.forEach(e=>{e.score=10})}},new class{constructor(){this.element=document.getElementById("group-tab"),this.groupClassroom=document.getElementById("classroom-group"),this.groupCountSlider=null,this.roundBtn=null,this.squareBtn=null,this.lockTablesBtn=null,this.resetBtn=null,this.toggleEmptyTablesBtn=null,this.editGroupsBtn=null,this.tablePositions={},this.draggedTable=null,this.dragOffsetX=0,this.dragOffsetY=0,this.initialize()}initialize(){console.log("Initialisation de l'onglet Groupe"),this.createControls(),document.addEventListener("tabactivated",e=>{"group-tab"===e.detail.tabId&&this.onActivate()}),this.setupDragAndDrop(),document.addEventListener("storechanged",e=>{["groupCount","useRoundLayout","hideEmptyTables"].includes(e.detail.property)&&this.element.classList.contains("active")&&this.updateLayout()})}createControls(){let e=this.element.querySelector(".controls-group");e?e.innerHTML="":((e=document.createElement("div")).className="controls-group",this.element.insertBefore(e,this.groupClassroom)),this.lockTablesBtn=document.createElement("button"),this.lockTablesBtn.id="lockTablesGroup",this.lockTablesBtn.className="lock-btn locked",this.lockTablesBtn.textContent="Verrouiller les positions",this.lockTablesBtn.addEventListener("click",()=>this.toggleLock()),this.resetBtn=document.createElement("button"),this.resetBtn.id="resetGroupLayout",this.resetBtn.className="global-btn",this.resetBtn.textContent="Réinitialiser la disposition",this.resetBtn.addEventListener("click",()=>this.resetLayout()),this.toggleEmptyTablesBtn=document.createElement("button"),this.toggleEmptyTablesBtn.id="toggleEmptyTables",this.toggleEmptyTablesBtn.className="global-btn",this.toggleEmptyTablesBtn.textContent="Masquer tables vides",this.toggleEmptyTablesBtn.addEventListener("click",()=>{t.hideEmptyTables=!t.hideEmptyTables,this.toggleEmptyTablesBtn.textContent=t.hideEmptyTables?"Afficher tables vides":"Masquer tables vides"}),this.editGroupsBtn=document.createElement("button"),this.editGroupsBtn.id="editGroups",this.editGroupsBtn.className="global-btn",this.editGroupsBtn.textContent="Éditer les groupes",this.editGroupsBtn.addEventListener("click",()=>{document.querySelector('.tab[data-tab="group-edit-tab"]').click()});let n=document.createElement("div");n.className="slider-container";let s=document.createElement("label");s.htmlFor="groupCount",s.textContent="Nombre de groupes:",this.groupCountSlider=document.createElement("input"),this.groupCountSlider.type="range",this.groupCountSlider.id="groupCount",this.groupCountSlider.min="2",this.groupCountSlider.max="15",this.groupCountSlider.value=t.groupCount,this.groupCountSlider.addEventListener("input",()=>{t.groupCount=parseInt(this.groupCountSlider.value),document.getElementById("groupValue").textContent=t.groupCount});let a=document.createElement("span");a.id="groupValue",a.className="slider-value",a.textContent=t.groupCount,n.appendChild(s),n.appendChild(this.groupCountSlider),n.appendChild(a);let l=document.createElement("div");l.className="shape-buttons",this.roundBtn=document.createElement("button"),this.roundBtn.id="roundBtn",this.roundBtn.className="shape-btn round-btn",this.roundBtn.title="Disposer les tables en rond",this.roundBtn.innerHTML="⭕",this.roundBtn.addEventListener("click",()=>{t.useRoundLayout=!0,this.updateShapeButtonsState()}),this.squareBtn=document.createElement("button"),this.squareBtn.id="squareBtn",this.squareBtn.className="shape-btn square-btn active",this.squareBtn.title="Disposer les tables en carré",this.squareBtn.innerHTML="⬛",this.squareBtn.addEventListener("click",()=>{t.useRoundLayout=!1,this.updateShapeButtonsState()}),l.appendChild(this.roundBtn),l.appendChild(this.squareBtn),e.appendChild(this.lockTablesBtn),e.appendChild(this.resetBtn),e.appendChild(this.toggleEmptyTablesBtn),e.appendChild(this.editGroupsBtn),e.appendChild(n),e.appendChild(l)}updateShapeButtonsState(){this.roundBtn.classList.toggle("active",t.useRoundLayout),this.squareBtn.classList.toggle("active",!t.useRoundLayout)}onActivate(){console.log("Onglet Groupe activé"),this.updateLayout()}updateLayout(){this.applyGroupLayout()}resetLayout(){this.tablePositions={},this.updateLayout()}toggleLock(){t.tablesLockedGroup=!t.tablesLockedGroup,this.lockTablesBtn.textContent=t.tablesLockedGroup?"Déverrouiller les positions":"Verrouiller les positions",this.lockTablesBtn.classList.toggle("locked",t.tablesLockedGroup),document.querySelectorAll("#classroom-group .table").forEach(e=>{e.classList.toggle("draggable",!t.tablesLockedGroup)})}setupDragAndDrop(){document.addEventListener("tabledraginit",e=>{if(t.tablesLockedGroup)return;let{table:n,event:s}=e.detail;this.draggedTable=n;let a=n.element.getBoundingClientRect();this.dragOffsetX=s.clientX-a.left,this.dragOffsetY=s.clientY-a.top,n.element.classList.add("dragging"),document.body.style.userSelect="none"}),document.addEventListener("mousemove",e=>{if(!this.draggedTable)return;let t=e.clientX-this.dragOffsetX,n=e.clientY-this.dragOffsetY;this.draggedTable.setPosition(t,n),e.preventDefault()}),document.addEventListener("mouseup",()=>{if(!this.draggedTable)return;let e=parseInt(this.draggedTable.element.dataset.number);this.tablePositions[e]={left:this.draggedTable.element.style.left,top:this.draggedTable.element.style.top},this.draggedTable.element.classList.remove("dragging"),this.draggedTable=null,document.body.style.userSelect=""})}applyGroupLayout(){this.groupClassroom.innerHTML="",console.log("Début applyGroupLayout - Nombre de tables:",t.tables.length);let e=t.tables.filter(e=>e.element.dataset.studentId),n=t.tables.filter(e=>!e.element.dataset.studentId);console.log("Tables occupées:",e.length),console.log("Tables vides:",n.length);let s=Math.max(2,Math.floor(e.length/2));this.groupCountSlider.max=s,t.groupCount=Math.min(t.groupCount,s),this.groupCountSlider.value=t.groupCount,document.getElementById("groupValue").textContent=t.groupCount;let a=this.calculateGroupPositions(t.groupCount);a.separators.forEach(e=>{let t=document.createElement("div");t.className=`group-separator separator-${e.type}`,e.type,t.style.left=`${e.x}px`,t.style.top=`${e.y}px`,t.style.width=`${e.width}px`,t.style.height=`${e.height}px`,this.groupClassroom.appendChild(t)});for(let e=0;e<t.groupCount;e++){let t=document.createElement("div");t.className="group-container",t.id=`group-${e+1}`;let n=a.dimensions[e];if(n){t.style.left=`${n.left}px`,t.style.top=`${n.top}px`,t.style.width=`${n.width}px`,t.style.height=`${n.height}px`;let s=document.createElement("div");s.className="group-number",s.textContent=e+1,t.appendChild(s)}this.groupClassroom.appendChild(t)}e.length,t.groupCount,t.tables.forEach(e=>{e.element.parentNode&&e.element.parentNode.removeChild(e.element);let n=parseInt(e.element.dataset.number),s=!!e.element.dataset.studentId;if(s||!t.hideEmptyTables){if(e.element.style.position="absolute",this.tablePositions[n])e.element.style.left=this.tablePositions[n].left,e.element.style.top=this.tablePositions[n].top,this.groupClassroom.appendChild(e.element);else{let t=this.getDefaultTablePosition(e,n,s,a);e.setPosition(t.x,t.y),s?e.element.classList.remove("empty-table"):e.element.classList.add("empty-table"),this.groupClassroom.appendChild(e.element)}e.element.classList.toggle("draggable",!t.tablesLockedGroup)}})}getDefaultTablePosition(e,n,s,a){if(!s){t.tables.filter(e=>!e.element.dataset.studentId).length;let n=t.tables.filter(e=>!e.element.dataset.studentId).indexOf(e),s=Math.floor(n/5);return{x:800+n%5*130,y:500+90*s}}let l=parseInt(e.element.dataset.groupNum)||1,o=Math.min(l-1,t.groupCount-1),d=a.dimensions[o];if(!d)return{x:400,y:300};let i=d.left+d.width/2,r=d.top+d.height/2,u=t.tables.filter(e=>e.element.dataset.studentId&&parseInt(e.element.dataset.groupNum||1)===l).length;if(t.useRoundLayout){let n=t.tables.filter(e=>e.element.dataset.studentId&&parseInt(e.element.dataset.groupNum||1)===l).indexOf(e),s=Math.max(80,Math.min(d.width,d.height)/2.5),a=n/u*2*Math.PI;return{x:i+Math.cos(a)*s-60,y:r+Math.sin(a)*s-40}}{let n=t.tables.filter(e=>e.element.dataset.studentId&&parseInt(e.element.dataset.groupNum||1)===l).indexOf(e),s=Math.ceil(Math.sqrt(u)),a=Math.ceil(u/s),o=Math.floor(n/s);return{x:i-(120*s+(s-1)*20)/2+n%s*140,y:r-(80*a+(a-1)*20)/2+100*o}}}calculateGroupPositions(e){let t,n,s=this.groupClassroom,a=s.offsetWidth||800,l=s.offsetHeight||600;e<=3?(n=1,t=e):e<=6?(n=2,t=Math.ceil(e/2)):(n=3,t=Math.ceil(e/3));let o=(a-(t+1)*30)/t,d=(l-(n+1)*30)/n,i=[],r=[];for(let s=0;s<n;s++)for(let n=0;n<t&&!(s*t+n>=e);n++){let e=30+n*(o+30),t=30+s*(d+30);r.push({left:e,top:t,width:o,height:d})}for(let e=1;e<t;e++){let t=e*(o+30);i.push({type:"vertical",x:t,y:0,width:30,height:l})}for(let e=1;e<n;e++){let t=e*(d+30);i.push({type:"horizontal",x:0,y:t,width:a,height:30})}return{dimensions:r,separators:i}}},new class{constructor(){this.element=document.getElementById("students-tab"),this.tableBody=document.querySelector("#student-edit-table tbody"),this.addStudentBtn=document.getElementById("add-student"),this.saveStudentsBtn=document.getElementById("save-students"),this.exportScoresBtn=document.getElementById("export-student-scores"),this.initialize()}initialize(){console.log("Initialisation de l'onglet Étudiants"),document.addEventListener("tabactivated",e=>{"students-tab"===e.detail.tabId&&this.onActivate()}),document.addEventListener("storechanged",e=>{"students"===e.detail.property&&this.element.classList.contains("active")&&this.updateStudentTable()}),this.addStudentBtn.addEventListener("click",()=>this.addStudent()),this.saveStudentsBtn.addEventListener("click",()=>this.saveStudents()),this.exportScoresBtn.addEventListener("click",()=>this.exportStudentScores())}onActivate(){console.log("Onglet Étudiants activé"),this.updateStudentTable()}updateStudentTable(){this.tableBody.innerHTML="",t.students.forEach((e,t)=>{let n=document.createElement("tr"),s=document.createElement("td"),a=document.createElement("input");a.type="text",a.value=e.name,a.dataset.index=t,s.appendChild(a);let l=document.createElement("td"),o=document.createElement("input");o.type="number",o.value=e.score||this.getStudentScore(t),o.dataset.index=t,l.appendChild(o);let d=document.createElement("td"),i=document.createElement("input");i.type="checkbox",i.checked=e.absent,i.dataset.index=t,d.appendChild(i);let r=document.createElement("td"),u=document.createElement("button");u.textContent="Supprimer",u.className="global-btn",u.style.backgroundColor="#f44336",u.addEventListener("click",()=>this.deleteStudent(t)),r.appendChild(u),n.appendChild(s),n.appendChild(l),n.appendChild(d),n.appendChild(r),this.tableBody.appendChild(n)})}addStudent(){t.addStudent("Nouvel élève"),this.updateStudentTable(),setTimeout(()=>{let e=this.tableBody.querySelectorAll('input[type="text"]'),t=e[e.length-1];t&&(t.focus(),t.select())},0)}deleteStudent(e){if(confirm("Êtes-vous sûr de vouloir supprimer cet élève ?")){let n=[...t.students];n.splice(e,1),t.students=n;let s=`student-${e}`;t.tables.forEach(t=>{if(t.element.dataset.studentId===s)t.removeStudent();else if(parseInt(t.element.dataset.studentId?.replace("student-",""))>e){let e=parseInt(t.element.dataset.studentId.replace("student-",""));t.element.dataset.studentId=`student-${e-1}`}}),this.updateStudentTable()}}saveStudents(){let e=this.tableBody.querySelectorAll('input[type="text"]'),n=this.tableBody.querySelectorAll('input[type="number"]'),s=this.tableBody.querySelectorAll('input[type="checkbox"]'),a=[...t.students];e.forEach((e,t)=>{a[t]&&(a[t].name=e.value.trim())}),n.forEach((e,t)=>{a[t]&&(a[t].score=parseInt(e.value)||0,this.setStudentScore(t,a[t].score))}),s.forEach((e,t)=>{a[t]&&(a[t].absent=e.checked)}),t.students=a,this.updateStudentLabels(),alert("Modifications enregistrées avec succès !")}exportStudentScores(){let e=new Date,n=e.toLocaleDateString("fr-FR").replace(/\//g,"-"),s=e.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}).replace(":","h"),a="NOM,SCORE,ABSENT\n";t.students.forEach((e,t)=>{let n=e.score||this.getStudentScore(t);a+=`"${e.name}",${n},${e.absent?"Oui":"Non"}
`});let l=new Blob([new Uint8Array([239,187,191]),a],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),d=URL.createObjectURL(l),i=`scores_${t.className||"classe"}_${n}_${s}.csv`;o.setAttribute("href",d),o.setAttribute("download",i),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(d),alert("Export des scores terminé !")}getStudentScore(e){let n=`student-${e}`,s=t.tables.find(e=>e.element.dataset.studentId===n);return s?s.score:0}setStudentScore(e,n){let s=`student-${e}`,a=t.tables.find(e=>e.element.dataset.studentId===s);a&&(a.score=n)}updateStudentLabels(){let e=document.getElementById("student-labels");if(e.innerHTML="",0===t.students.length){let t=document.createElement("p");t.id="no-students-message",t.textContent="Chargez une liste d'élèves pour voir les étiquettes ici.",e.appendChild(t);return}t.students.forEach((t,n)=>{let s=document.createElement("div");s.className="student-label",t.absent&&s.classList.add("absent"),s.textContent=t.name,s.id="student-"+n,s.draggable=!0,s.dataset.absent=t.absent,s.addEventListener("dragstart",function(e){e.dataTransfer.setData("text/plain",s.id)}),e.appendChild(s)})}},new class{constructor(){this.element=document.getElementById("group-edit-tab"),this.container=document.getElementById("tabGroupEditContainer"),this.groupCountSlider=document.getElementById("tabGroupCount"),this.maxStudentsSlider=document.getElementById("tabMaxStudentsPerGroup"),this.randomizeBtn=document.getElementById("tabRandomizeGroups"),this.applyBtn=document.getElementById("tabApplyGroupChanges"),this.initialize()}initialize(){console.log("Initialisation de l'onglet d'édition des groupes"),document.addEventListener("tabactivated",e=>{"group-edit-tab"===e.detail.tabId&&this.onActivate()}),this.setupControls()}setupControls(){this.groupCountSlider.addEventListener("input",()=>{t.groupCount=parseInt(this.groupCountSlider.value),document.getElementById("tabGroupValue").textContent=t.groupCount,this.updateContent()}),this.maxStudentsSlider.addEventListener("input",()=>{t.maxStudentsPerGroup=parseInt(this.maxStudentsSlider.value),document.getElementById("tabMaxStudentsValue").textContent=t.maxStudentsPerGroup,this.updateContent()}),this.randomizeBtn.addEventListener("click",()=>{this.randomizeStudentsInGroups()}),this.applyBtn.addEventListener("click",()=>{this.saveGroupChanges()})}onActivate(){console.log("Onglet édition des groupes activé"),this.groupCountSlider.value=t.groupCount,document.getElementById("tabGroupValue").textContent=t.groupCount,this.maxStudentsSlider.value=t.maxStudentsPerGroup,document.getElementById("tabMaxStudentsValue").textContent=t.maxStudentsPerGroup,this.updateContent()}updateContent(){console.log("Mise à jour du contenu de l'éditeur de groupes");let e={};for(let n=1;n<=t.groupCount;n++)e[n]=[];t.tables.forEach(n=>{if(n.element.dataset.studentId){let s=n.element.dataset.studentId,a=parseInt(s.replace("student-","")),l=t.students[a]?.name||"Élève inconnu",o=Math.min(parseInt(n.element.dataset.groupNum)||1,t.groupCount);e[o].push({studentId:s,studentName:l,tableNumber:parseInt(n.element.dataset.number),groupNum:o})}}),this.container.innerHTML="";for(let s=1;s<=t.groupCount;s++){let a=e[s]||[],l=document.createElement("div");l.className="group-edit-box",l.dataset.groupNum=s;let o=document.createElement("div");o.className="group-edit-title",o.textContent=`Groupe ${s} (${a.length} \xe9l\xe8ves)`;let d=document.createElement("div");if(d.className="group-students-list",d.dataset.groupNum=s,a.length>0)a.sort((e,t)=>e.studentName.localeCompare(t.studentName)),a.forEach(e=>{let t=document.createElement("div");t.className="draggable-student",t.textContent=e.studentName,t.draggable=!0,t.dataset.studentId=e.studentId,t.dataset.tableNumber=e.tableNumber,t.dataset.originalGroup=e.groupNum,t.addEventListener("dragstart",function(t){t.dataTransfer.setData("text/plain",e.studentId),t.dataTransfer.setData("application/json",JSON.stringify(e)),this.classList.add("student-dragging")}),t.addEventListener("dragend",function(){this.classList.remove("student-dragging")}),d.appendChild(t)});else{let e=document.createElement("div");e.className="empty-group-message",e.textContent="Glissez des élèves ici",e.style.color="#999",e.style.fontStyle="italic",e.style.padding="10px",e.style.textAlign="center",d.appendChild(e)}d.addEventListener("dragover",function(e){if((e.preventDefault(),!(this.querySelectorAll(".draggable-student").length>=t.maxStudentsPerGroup))&&!this.querySelector(".group-placeholder")&&!this.querySelector(".empty-group-message")){let e=document.createElement("div");e.className="group-placeholder",this.appendChild(e)}}),d.addEventListener("dragleave",function(e){let t=this.querySelector(".group-placeholder");t&&t.remove()}),d.addEventListener("drop",function(e){if(e.preventDefault(),this.querySelectorAll(".draggable-student").length>=t.maxStudentsPerGroup)return;this.querySelectorAll(".group-placeholder, .empty-group-message").forEach(e=>e.remove());let s=e.dataTransfer.getData("text/plain");try{JSON.parse(e.dataTransfer.getData("application/json"))}catch(e){console.error("Erreur lors de la récupération des données:",e);return}let a=document.querySelector(`.draggable-student[data-student-id="${s}"]`);if(a){let e=parseInt(a.dataset.originalGroup);if(a.parentNode){a.parentNode.removeChild(a),n(e);let t=document.querySelector(`.group-students-list[data-group-num="${e}"]`);if(t&&0===t.children.length){let e=document.createElement("div");e.className="empty-group-message",e.textContent="Glissez des élèves ici",e.style.color="#999",e.style.fontStyle="italic",e.style.padding="10px",e.style.textAlign="center",t.appendChild(e)}}let t=parseInt(this.dataset.groupNum);a.dataset.originalGroup=t,this.appendChild(a),n(t)}}),l.appendChild(o),l.appendChild(d),this.container.appendChild(l)}function n(e){let t=document.querySelector(`.group-edit-box[data-group-num="${e}"] .group-edit-title`),n=document.querySelector(`.group-students-list[data-group-num="${e}"]`);if(t&&n){let s=n.querySelectorAll(".draggable-student").length;t.textContent=`Groupe ${e} (${s} \xe9l\xe8ves)`}}}randomizeStudentsInGroups(){console.log("Répartition aléatoire en",t.groupCount,"groupes");let e=t.tables.filter(e=>e.element.dataset.studentId);if(0===e.length)return void alert("Aucun élève n'est assigné à une table. Impossible de créer des groupes.");let n=[...e];this.shuffleArray(n);let s=Math.ceil(n.length/t.groupCount);n.forEach((e,t)=>{let n=Math.floor(t/s)+1,a=parseInt(e.element.dataset.groupNum)||0;e.element.dataset.groupNum=n.toString(),console.log(`Table ${e.element.dataset.number}: ${a||"non assigné"} \u{2192} ${n}`)}),this.updateContent();let a=document.createElement("div");a.style.background="#4CAF50",a.style.color="white",a.style.padding="8px",a.style.marginBottom="15px",a.style.borderRadius="4px",a.style.textAlign="center",a.innerHTML=`\u{2705} R\xe9partition al\xe9atoire termin\xe9e : ${e.length} \xe9l\xe8ves r\xe9partis en ${t.groupCount} groupes`,this.container.insertBefore(a,this.container.firstChild),setTimeout(()=>{a.style.opacity="0",a.style.transition="opacity 0.5s",setTimeout(()=>a.remove(),500)},3e3)}saveGroupChanges(){console.log("Sauvegarde des modifications des groupes");let e={};t.tables.forEach(t=>{t.element.dataset.studentId&&(e[t.element.dataset.number]=parseInt(t.element.dataset.groupNum)||0)});let n=[];document.querySelectorAll("#tabGroupEditContainer .group-students-list").forEach(e=>{let t=parseInt(e.dataset.groupNum);e.querySelectorAll(".draggable-student").forEach(e=>{let s=parseInt(e.dataset.tableNumber);n.push({tableNumber:s,newGroup:t})})});let s=[];if(n.forEach(e=>{let n=t.tables.find(t=>parseInt(t.element.dataset.number)===e.tableNumber);if(n){let t=parseInt(n.element.dataset.groupNum)||0;t!==e.newGroup&&(n.element.dataset.groupNum=e.newGroup.toString(),s.push({tableNumber:e.tableNumber,from:t,to:e.newGroup,studentName:this.getStudentNameFromTable(n.element)}),n.element.setAttribute("data-group-changed","true"),setTimeout(()=>n.element.removeAttribute("data-group-changed"),3e3))}}),t.groupsEdited=!0,document.querySelector('.tab[data-tab="group-tab"]').click(),s.length>0)console.log("=== RÉSUMÉ DES CHANGEMENTS ==="),s.forEach(e=>{console.log(`\u{2022} ${e.studentName} (Table ${e.tableNumber}): Groupe ${e.from||"non assigné"} \u{2192} Groupe ${e.to}`)}),this.showChangesNotification(s);else{console.log("Aucun changement dans les groupes.");let e=document.createElement("div");e.style.position="fixed",e.style.top="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.padding="15px 20px",e.style.backgroundColor="#ff9800",e.style.color="white",e.style.borderRadius="5px",e.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",e.style.zIndex="10000",e.textContent="Aucun changement détecté dans les groupes.",document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 0.5s ease",setTimeout(()=>e.remove(),500)},5e3)}}shuffleArray(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}getStudentNameFromTable(e){if(!e||!e.dataset.studentId)return"Élève inconnu";let n=parseInt(e.dataset.studentId.replace("student-",""));return t.students[n]?.name||"Élève inconnu"}showChangesNotification(e){let t=document.createElement("div");t.style.position="fixed",t.style.top="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.padding="15px 20px",t.style.backgroundColor="#4CAF50",t.style.color="white",t.style.borderRadius="5px",t.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",t.style.zIndex="10000",t.style.maxWidth="80%",t.style.maxHeight="80vh",t.style.overflow="auto";let n=`<strong>${e.length} \xe9l\xe8ves ont chang\xe9 de groupe</strong>`;n+=`
            <button id="toggleChangesBtn" style="margin-left: 10px; padding: 5px 10px; background: white; color: #4CAF50; border: none; border-radius: 3px; cursor: pointer;">
                Voir les d\xe9tails
            </button>
            <div id="changesDetails" style="display: none; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px;">
                <ul style="margin: 0; padding-left: 20px;">
        `,e.forEach(e=>{n+=`<li>${e.studentName} (Table ${e.tableNumber}): Groupe ${e.from||"non assigné"} \u{2192} Groupe ${e.to}</li>`}),t.innerHTML=n+=`
                </ul>
            </div>
        `,document.body.appendChild(t),setTimeout(()=>{document.getElementById("toggleChangesBtn").addEventListener("click",function(){let e=document.getElementById("changesDetails");"none"===e.style.display?(e.style.display="block",this.textContent="Masquer les détails"):(e.style.display="none",this.textContent="Voir les détails")})},100),setTimeout(()=>{t.style.opacity="0",t.style.transition="opacity 0.5s ease",setTimeout(()=>t.remove(),500)},1e4)}},document.addEventListener("DOMContentLoaded",()=>{console.log("Initialisation de l'application..."),function(){if(document.querySelectorAll(".tab").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),this.classList.add("active");let e=this.dataset.tab,t=document.getElementById(e);if(t){t.classList.add("active");let n=new CustomEvent("tabactivated",{detail:{tabId:e}});document.dispatchEvent(n),console.log(`Onglet activ\xe9: ${e}`)}})}),document.querySelector(".tab.active")){let e=new CustomEvent("tabactivated",{detail:{tabId:document.querySelector(".tab.active").dataset.tab}});document.dispatchEvent(e)}else{let e=document.querySelector(".tab");e&&e.click()}}(),function(){let e=document.getElementById("save-class-name"),n=document.getElementById("class-name-input");e.addEventListener("click",()=>{t.className=n.value.trim(),o()}),t.className&&(n.value=t.className,o())}(),document.getElementById("exportCSV").addEventListener("click",s),document.getElementById("csvFileInput").addEventListener("change",e=>{let n=e.target.files[0];n&&function(e){if(!e)return;let n=new FileReader;n.onload=function(e){let n=function(e){new TextDecoder("utf-8");let n=e;65279===e.charCodeAt(0)&&(n=e.slice(1));let s=n.split("\n"),o=!1,d="";if(s.length>0&&s[0].trim().includes("TYPE,CLASSROOM_DATA")){o=!0;for(let e=1;e<s.length;e++){let t=s[e].trim();if(t.startsWith("CLASS_NAME,"))d=t.split(",")[1];else if(t.startsWith("TABLE,"))break}}return o?function(e,n){console.log("Import d'un fichier exporté par l'application"),n&&(t.className=n,document.getElementById("class-name-input").value=n);let s=[],o={},d={},i=!1,r=!1;for(let t=0;t<e.length;t++){let n=e[t].trim();if(n.startsWith("TABLE,ÉLÈVE")){r=!0,i=!1;continue}if(n.startsWith("NON_ASSIGNED_STUDENTS")){r=!1,i=!0;continue}if(!n.startsWith("ID,NOM,ABSENT")){if(r&&n){let e=l(n);if(e.length>=6){let t=e[0],n=e[1].replace(/"/g,""),a=e[2],l="oui"===e[3].toLowerCase(),i=e[4],r=e[5];if(i&&r&&(d[t]={left:i,top:r}),"Non assigné"!==n){let e=s.findIndex(e=>e.name===n);-1===e&&(s.push({name:n,absent:l,score:a}),e=s.length-1),o[t]={studentIndex:e,score:a}}}}else if(i&&n){let e=l(n);if(e.length>=3){let t=e[1].replace(/"/g,""),n="oui"===e[2].toLowerCase();s.some(e=>e.name===t)||s.push({name:t,absent:n,score:0})}}}}for(let[e,n]of(t.students=s,a(s,Object.values(o).map(e=>e.studentIndex)),Object.entries(o))){let s=t.tables.find(t=>parseInt(t.element.dataset.number)===parseInt(e));if(s&&n.studentIndex>=0){let t=`student-${n.studentIndex}`;s.assignStudent(t),s.score=parseInt(n.score)||0;let a=d[e];a&&(s.element.style.position="absolute",s.element.style.left=a.left,s.element.style.top=a.top)}}return{type:"app-export",success:!0,message:"Configuration importée avec succès!"}}(s,d):function(e){console.log("Import d'une liste d'élèves simple");let n=[],s=e[0].trim().toLowerCase(),o=+!!(s.includes("nom")||s.includes("élève")||s.includes("absent"));for(let t=o;t<e.length;t++){let s=e[t].trim();if(s){let e=l(s);if(e.length>0){let t=e[0].replace(/"/g,"").trim(),s=!1;if(e.length>1){let t=e[1].trim().toLowerCase();s="oui"===t||"true"===t||"1"===t}n.push({name:t,absent:s,score:0})}}}return t.students=n,a(n,[]),{type:"simple-list",success:!0,message:`Liste d'\xe9l\xe8ves import\xe9e avec succ\xe8s! (${n.length} \xe9l\xe8ves)`,count:n.length}}(s)}(e.target.result);n.success&&alert(n.message)},n.readAsText(e,"UTF-8")}(n)}),document.getElementById("incrementAllScores").addEventListener("click",()=>d(1)),document.getElementById("decrementAllScores").addEventListener("click",()=>d(-1)),console.log("Initialisation du système de drag and drop global"),document.addEventListener("dragover",function(e){e.preventDefault()}),document.addEventListener("drop",function(e){e.target.closest(".table")||e.target.closest(".group-students-list")||e.preventDefault()}),document.addEventListener("dragstart",function(e){(e.target.classList.contains("student-label")||e.target.classList.contains("draggable-student"))&&(e.target.style.opacity="0.4")}),document.addEventListener("dragend",function(e){(e.target.classList.contains("student-label")||e.target.classList.contains("draggable-student"))&&(e.target.style.opacity="1")}),console.log("Application initialisée")});
//# sourceMappingURL=DispositionClasse.a36e2a01.js.map
